<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postulación Desafío Territorial - U. Aysén</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f6f9;
            color: #333;
        }
        .header-ua {
            background-color: #003366; /* Azul U Aysén aproximado */
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-bottom: 5px solid #d9d9d9;
        }
        .form-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            border-left: 5px solid #003366;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #003366;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .card-objetivo {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        .total-row {
            background-color: #003366;
            color: white;
            font-weight: bold;
        }
        .total-row input {
            background-color: white;
            color: #000;
            font-weight: bold;
            text-align: right;
        }
        /* Spinner de carga */
        .loader {
            display: none;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #003366;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="header-ua text-center">
        <div class="container">
            <h1>Formulario de Postulación</h1>
            <p class="lead mb-0">Anexo 1: Desafío Territorial y Admisibilidad</p>
        </div>
    </div>

    <div class="container">
        <form id="postulacionForm">
            
            <div class="form-section">
                <div class="section-title">1. Identificación de la Institución u Organización</div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">Nombre de la institución</label>
                        <input type="text" class="form-control" name="inst_nombre" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">RUT</label>
                        <input type="text" class="form-control" name="inst_rut" placeholder="12.345.678-9" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tipo de institución</label>
                        <select class="form-select" name="inst_tipo" required>
                            <option value="">Seleccione...</option>
                            <option value="Pública">Pública</option>
                            <option value="Privada">Privada</option>
                            <option value="Académica">Académica</option>
                            <option value="Sociedad Civil">Sociedad Civil</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-control" name="inst_direccion" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Correo institucional</label>
                        <input type="email" class="form-control" name="inst_email" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" name="inst_fono" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">2. Identificación del Representante Legal</div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">Nombres y Apellidos</label>
                        <input type="text" class="form-control" name="rep_nombre" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">RUN</label>
                        <input type="text" class="form-control" name="rep_run" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Cargo</label>
                        <input type="text" class="form-control" name="rep_cargo" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Correo</label>
                        <input type="email" class="form-control" name="rep_email" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">3. Supervisor del Profesional Alumni</div>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">Nombres y Apellidos</label>
                        <input type="text" class="form-control" name="sup_nombre" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">RUN</label>
                        <input type="text" class="form-control" name="sup_run" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Cargo</label>
                        <input type="text" class="form-control" name="sup_cargo" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Correo</label>
                        <input type="email" class="form-control" name="sup_email" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">4. Resumen de la Iniciativa</div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Justificación del desafío y Diagnóstico</label>
                    <p class="form-text text-muted">Incluya: Necesidad territorial, pertinencia con Aysén y beneficiarios directos/indirectos.</p>
                    <textarea class="form-control" name="justificacion" rows="6" maxlength="3000" required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Área estratégica (Seleccione una)</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="area_estrategica" value="Turismo" required>
                        <label class="form-check-label">Desarrollo del Turismo Regional</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="area_estrategica" value="Energía">
                        <label class="form-check-label">Desarrollo Energético</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="area_estrategica" value="Ambiental">
                        <label class="form-check-label">Conservación y Protección Ambiental</label>
                    </div>
                     <div class="form-check">
                        <input class="form-check-input" type="radio" name="area_estrategica" value="Productivo">
                        <label class="form-check-label">Desarrollo Encadenamientos Productivos</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="area_estrategica" value="Silvoagropecuario">
                        <label class="form-check-label">Desarrollo del Sector Silvoagropecuario</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="area_estrategica" value="Salud">
                        <label class="form-check-label">Mejoramiento de la Atención de Salud</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Contribución al área estratégica</label>
                    <textarea class="form-control" name="contribucion_area" rows="3" required></textarea>
                </div>

                <label class="form-label fw-bold mt-4">Objetivos, actividades y resultados</label>
                <div id="objetivos-container">
                    </div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="agregarObjetivo()">
                    + Agregar Objetivo Específico
                </button>
            </div>

            <div class="form-section">
                <div class="section-title">Perfil Profesional y Plan de Formación</div>
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">Objetivo del cargo</label>
                        <textarea class="form-control" name="perfil_objetivo" rows="2" required></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Carrera requerida (UAysén)</label>
                        <select class="form-select" name="perfil_carrera" required>
                            <option value="">Seleccione...</option>
                            <option value="Agronomía">Agronomía</option>
                            <option value="Enfermería">Enfermería</option>
                            <option value="Ingeniería Civil Industrial">Ingeniería Civil Industrial</option>
                            <option value="Ingeniería Forestal">Ingeniería Forestal</option>
                            <option value="Psicología">Psicología</option>
                            <option value="Trabajo Social">Trabajo Social</option>
                            <option value="Obstetricia">Obstetricia</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Labores específicas del Alumni</label>
                        <textarea class="form-control" name="perfil_labores" rows="3" required></textarea>
                    </div>
                    <div class="col-md-12">
                        <label class="form-label fw-bold">Plan de formación complementaria</label>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Competencias Técnicas a fortalecer</label>
                        <input type="text" class="form-control" name="plan_tecnico" placeholder="Ej: Excel avanzado, Normativa X" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Habilidades Blandas a fortalecer</label>
                        <input type="text" class="form-control" name="plan_blando" placeholder="Ej: Liderazgo, Trabajo en equipo" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Impacto Territorial</label>
                        <textarea class="form-control" name="impacto" rows="2" required></textarea>
                    </div>
                     <div class="col-md-6">
                        <label class="form-label">Sostenibilidad</label>
                        <textarea class="form-control" name="sostenibilidad" rows="2" required></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">5. Financiamiento</div>
                <p class="text-muted small">Los montos deben ser ingresados sin puntos ni comas.</p>
                
                <table class="table table-bordered table-responsive-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Ítem / Subítem</th>
                            <th width="25%">Aporte UAysén ($)</th>
                            <th width="25%">Aporte Socio ($)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <strong>Recursos Humanos</strong><br>
                                <span class="small text-muted">Honorarios Alumni (12 meses)</span>
                            </td>
                            <td>
                                <input type="number" class="form-control" value="13200000" readonly name="monto_uaysen_rrhh">
                            </td>
                            <td>
                                <input type="number" class="form-control" value="0" disabled>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <strong>Gastos de Operación</strong><br>
                                <span class="small text-muted">Movilización, Viáticos, Seguros, etc.</span>
                            </td>
                            <td>
                                <input type="number" class="form-control" value="0" disabled>
                            </td>
                            <td>
                                <input type="number" class="form-control bg-white" id="input_op_socio" name="monto_socio_op" required>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <strong>Capacitación y Formación</strong><br>
                                <span class="small text-muted">Cursos, talleres, certificaciones</span>
                            </td>
                            <td>
                                <input type="number" class="form-control bg-white" id="input_cap_uaysen" name="monto_uaysen_cap">
                            </td>
                            <td>
                                <input type="number" class="form-control bg-white" id="input_cap_socio" name="monto_socio_cap">
                            </td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>TOTAL</strong></td>
                            <td>
                                <input type="number" class="form-control" id="total_uaysen" readonly>
                            </td>
                            <td>
                                <input type="number" class="form-control" id="total_socio" readonly>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="text-center my-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    Enviar Postulación
                    <span class="loader" id="submitLoader"></span>
                </button>
            </div>

        </form>

        <div id="mensajeResultado" class="alert mt-3" style="display:none;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let contadorObjetivos = 0;

        // Función para agregar objetivo específico
        function agregarObjetivo() {
            contadorObjetivos++;
            const container = document.getElementById('objetivos-container');
            const objetivoHTML = `
                <div class="card card-objetivo" id="objetivo-${contadorObjetivos}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0">Objetivo Específico ${contadorObjetivos}</h6>
                            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarObjetivo(${contadorObjetivos})">
                                Eliminar
                            </button>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Descripción del objetivo</label>
                            <textarea class="form-control" name="objetivo_${contadorObjetivos}_desc" rows="2" required></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Actividades</label>
                            <textarea class="form-control" name="objetivo_${contadorObjetivos}_actividades" rows="2" required></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Resultados esperados</label>
                            <textarea class="form-control" name="objetivo_${contadorObjetivos}_resultados" rows="2" required></textarea>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', objetivoHTML);
        }

        // Función para eliminar objetivo específico
        function eliminarObjetivo(id) {
            const elemento = document.getElementById(`objetivo-${id}`);
            if (elemento) {
                elemento.remove();
            }
        }

        // Calcular totales de financiamiento
        function calcularTotales() {
            // UAysén
            const rrhh = parseFloat(document.querySelector('[name="monto_uaysen_rrhh"]').value) || 0;
            const capUaysen = parseFloat(document.getElementById('input_cap_uaysen').value) || 0;
            document.getElementById('total_uaysen').value = rrhh + capUaysen;

            // Socio
            const opSocio = parseFloat(document.getElementById('input_op_socio').value) || 0;
            const capSocio = parseFloat(document.getElementById('input_cap_socio').value) || 0;
            document.getElementById('total_socio').value = opSocio + capSocio;
        }

        // Event listeners para calcular totales
        document.getElementById('input_op_socio').addEventListener('input', calcularTotales);
        document.getElementById('input_cap_uaysen').addEventListener('input', calcularTotales);
        document.getElementById('input_cap_socio').addEventListener('input', calcularTotales);

        // Calcular totales al cargar
        calcularTotales();

        // Manejo del envío del formulario
        document.getElementById('postulacionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loader = document.getElementById('submitLoader');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const mensajeDiv = document.getElementById('mensajeResultado');
            
            // Mostrar loader
            loader.style.display = 'inline-block';
            submitBtn.disabled = true;

            // Recopilar datos del formulario
            const formData = new FormData(this);
            const datos = {};
            
            formData.forEach((value, key) => {
                datos[key] = value;
            });

            // Agregar objetivos como array
            const objetivos = [];
            for (let i = 1; i <= contadorObjetivos; i++) {
                const objetivo = document.getElementById(`objetivo-${i}`);
                if (objetivo) {
                    objetivos.push({
                        descripcion: datos[`objetivo_${i}_desc`],
                        actividades: datos[`objetivo_${i}_actividades`],
                        resultados: datos[`objetivo_${i}_resultados`]
                    });
                }
            }
            datos.objetivos = objetivos;

            try {
                // Enviar datos al servidor
                const response = await fetch('/api/postulacion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });

                const resultado = await response.json();

                if (response.ok) {
                    mensajeDiv.className = 'alert alert-success mt-3';
                    mensajeDiv.textContent = '✓ Postulación enviada exitosamente. ID: ' + resultado.id;
                    mensajeDiv.style.display = 'block';
                    
                    // Limpiar formulario
                    this.reset();
                    document.getElementById('objetivos-container').innerHTML = '';
                    contadorObjetivos = 0;
                    calcularTotales();
                } else {
                    throw new Error(resultado.error || 'Error al enviar la postulación');
                }
            } catch (error) {
                mensajeDiv.className = 'alert alert-danger mt-3';
                mensajeDiv.textContent = '✗ Error: ' + error.message;
                mensajeDiv.style.display = 'block';
            } finally {
                // Ocultar loader
                loader.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Agregar un objetivo por defecto al cargar
        agregarObjetivo();
    </script>

</body>
</html>
